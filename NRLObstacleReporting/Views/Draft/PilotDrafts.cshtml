@model ObstacleCompleteModel
@{
    ViewData["Title"] = "Drafts";
}

@{
    var data = (IEnumerable<ObstacleCompleteModel>)ViewData["drafts"]!;
    var drafts = data.ToArray();
}

@if (!drafts.Any())
{
    <div class="text-center">
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">No drafts registered</h1>
    </div>
}
else
{
    <div class="text-center mb-6">
        <h1 class="py-1 sm:py-4 mb-2 text-4xl font-bold text-gray-900 dark:text-gray-100">Registered drafts</h1>
    </div>

    @foreach (var draft in drafts)
    {
        var mapId = draft.ObstacleId.ToString();

        <form asp-controller="Draft" asp-action="EditDraft" method="post">
            @Html.AntiForgeryToken()

            <div class="rounded-xl 
            border border-[#1c2b45]/40 dark:border-[#0f172a]/40
            bg-[#f8fafc] dark:bg-[#1e293b]
            shadow-[0_4px_12px_rgba(0,0,0,0.15)]
            p-4 mb-10 w-full 
            transition-colors duration-300">
                
            <table class="w-full table-fixed border-collapse 
                              !bg-transparent !text-black dark:!text-gray-100">
                    <tbody>

                        <!-- ID -->
                        <tr class="!bg-gray-200 dark:!bg-gray-700">
                            <th class="p-3 text-sm font-bold text-left !text-black dark:!text-gray-100">Id</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.ObstacleId</td>
                        </tr>

                        <!-- Height -->
                        <tr class="!bg-white dark:!bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Height</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.HeightMeter</td>
                        </tr>

                        <!-- Type -->
                        <tr class="!bg-gray-200 dark:!bg-gray-700 border-b border-gray-300 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Type</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.Type</td>
                        </tr>

                        <!-- Name -->
                        <tr class="!bg-white dark:!bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Name</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.Name</td>
                        </tr>

                        <!-- Description -->
                        <tr class="!bg-gray-200 dark:!bg-gray-700 border-b border-gray-300 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Description</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.Description</td>
                        </tr>

                        <!-- Illuminated -->
                        <tr class="!bg-white dark:!bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Illumination</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.Illuminated</td>
                        </tr>

                        <!-- Marking -->
                        <tr class="!bg-gray-200 dark:!bg-gray-700 border-b border-gray-300 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Marking</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.Marking</td>
                        </tr>

                        <!-- Created -->
                        <tr class="!bg-white dark:!bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Creation Time</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.CreationTime</td>
                        </tr>

                        <!-- Updated -->
                        <tr class="!bg-gray-200 dark:!bg-gray-700 border-b border-gray-300 dark:border-gray-700">
                            <th class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">Updated Time</th>
                            <td class="p-3 text-sm !text-black dark:!text-gray-100">@draft.UpdatedTime</td>
                        </tr>

                        <!-- MAP -->
                        @if (draft.GeometryGeoJson != null)
                        {
                            <tr class="!bg-white dark:!bg-gray-800">
                                <td colspan="2" class="p-3 text-sm font-semibold !text-black dark:!text-gray-100">

                                    <details class="cursor-pointer">
                                        <summary class="text-blue-600 dark:text-blue-400">Map</summary>

                                        <div class="w-full overflow-hidden rounded-xl mt-3 border border-gray-300 dark:border-gray-700">
                                            <div id="@mapId"
                                                 class="w-full mx-auto mb-2"
                                                 style="height:30dvh;width:100%;border-radius:0.75rem;overflow:hidden; z-index: 0"></div>
                                        </div>

                                        <script>
                                            var map = L.map('@mapId').setView([58.14671, 7.9956], 17);

                                            L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}.png', {
                                                maxZoom: 19,
                                                attribution: '&copy; OpenStreetMap contributors'
                                            }).addTo(map);

                                            var geojson = @Html.Raw(draft.GeometryGeoJson);
                                            var geojsonLayer = L.geoJSON(geojson).addTo(map);

                                            map.setMaxBounds(geojsonLayer.getBounds());
                                        </script>

                                    </details>

                                </td>
                            </tr>
                        }

                        <!-- EDIT BUTTON -->
                        <tr class="!bg-white dark:!bg-gray-800">
                            <td colspan="2" class="p-0">
                                <button type="submit"
                                        formaction="/Draft/EditDraft"
                                        class="block w-full text-center
                                               bg-blue-600 hover:bg-blue-700
                                               dark:bg-blue-500 dark:hover:bg-blue-400
                                               text-white font-semibold py-3 rounded-b-xl
                                               transition-colors">
                                    Edit
                                </button>
                            </td>
                        </tr>

                    </tbody>
                </table>

            </div>

            <!-- Hidden inputs -->
            <input type="hidden" asp-for="GeometryGeoJson" value="@draft.GeometryGeoJson" />
            <input type="hidden" asp-for="Description" value="@draft.Description" />
            <input type="hidden" asp-for="Illuminated" value="@draft.Illuminated" />
            <input type="hidden" asp-for="Name" value="@draft.Name" />
            <input type="hidden" asp-for="Type" value="@draft.Type" />
            <input type="hidden" asp-for="HeightMeter" value="@draft.HeightMeter" />
            <input type="hidden" asp-for="ObstacleId" value="@draft.ObstacleId" />
            <input type="hidden" asp-for="Marking" value="@draft.Marking" />
        </form>
    }
}
