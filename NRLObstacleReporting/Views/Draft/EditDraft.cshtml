@model NRLObstacleReporting.Models.ObstacleCompleteModel
@{
    ViewData["Title"] = "Edit Draft";
}
<div class="py-8 px-4 mx-auto max-w-2xl lg:py-16">
    <form method="post" asp-action="SaveEditedDraft">
        <input type="hidden" asp-for="GeometryGeoJson" id="GeometryGeoJson"/>

        <h2 class="py-1 sm:py-4 mb-2 text-4xl font-bold text-gray-900 ">Edit draft</h2>
        <div class="py-3 grid gap-4 sm:grid-cols-2 sm:gap-6">
            <div>
                <label asp-for="Type" class="block mb-2 text-sm font-medium text-gray-900">Obstacle type </label>
                <select asp-for="Type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                    <option selected="">Select obstacle type</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleTypes.AirSpan)">Aerial span</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleTypes.PoleOrTower)">Pole/Tower</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleTypes.Building)">Building</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleTypes.Construction)">Construction</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleTypes.Bridge)">Bridge</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleTypes.Other)">Other</option>
                </select>
            </div>
            <div class="w-full">
                <label asp-for="HeightMeter" class="block mb-2 text-sm font-medium text-gray-900">Height </label>
                <input asp-for="HeightMeter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5" placeholder="Type obstacle HeightMeter" required=""/>
                <span asp-validation-for="HeightMeter"></span>
            </div>
            <div>
                <label asp-for="Illuminated" class="block mb-2 text-sm font-medium text-gray-900">Illumination </label>
                <select asp-for="Illuminated" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                    <option selected="">Select illumination status</option>
                    <<option value="@((int)ObstacleCompleteModel.Illumination.Illuminated)">Illuminated</option>
                    <option value="@((int)ObstacleCompleteModel.Illumination.NotIlluminated)">Not illuminated</option>
                    <option value="@((int)ObstacleCompleteModel.Illumination.Unknown)">Unknown</option>
                </select>
                <span asp-validation-for="Illuminated"></span>
            </div>
            <div>
                <label asp-for="Marking" class="block mb-2 text-sm font-medium text-gray-900">Obstacle marking status </label>
                <select asp-for="Marking" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                    <option selected="">Select obstacle marking status</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleMarking.Marked)">Marked</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleMarking.NotMarked)">Not marked</option>
                    <option value="@((int)ObstacleCompleteModel.ObstacleMarking.Unknown)">Unknown</option>
                </select>
                <span asp-validation-for="Marking"></span>
            </div>
            <div class="sm:col-span-2">
                <label asp-for="Name" class="block mb-2 text-sm font-medium text-gray-900">Name </label>
                <input asp-for="Name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5" placeholder="Type obstacle name">
                <span asp-validation-for="Name"></span>
            </div>
            <div class="sm:col-span-2">
                <label asp-for="Description" class="block mb-2 text-sm font-medium text-gray-900">Description </label>
                <textarea asp-for="Description" rows = "7" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5" placeholder="Type obstacle description"></textarea>
                <span asp-validation-for="Description"></span>
            </div>
            
         
            @if (Model.GeometryGeoJson != null)
            {
                <div class="sm:col-span-2">
                    <label class = "block mb-2 text-sm font-medium text-gray-900">Map </label>
                    <div class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5  ">
                        <details>
                            <summary>Map</summary>
                            <div class="overflow-hidden rounded-xl mt-2">
                                <div id="map" class="mx-auto mb-2" style="height:50dvh;width:100%;border-radius:0.75rem;overflow:hidden;border:1px solid #e5e7eb;margin:0;padding:0; z-index: 0"></div>
                            </div>
                            <div class="sm:col-span-2">
                                <label for="CoordinatesPreview" class="block text-sm font-medium text-gray-800 mb-1">
                                    Coordinates Preview
                                </label>
                                <textarea id="CoordinatesPreview"
                                          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block p-2.5 w-full"
                                          style="height: 6dvh;"
                                          readonly></textarea>
                                </div>
                            <script>
                            
                            //leaflet
                            var map = L.map('map').setView([58.14671, 7.9956], 17);

                                //adjustment of map color
                                L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}.png', {
                                maxZoom: 19,
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                            }).addTo(map); //adds map object so its actually being shown

                            var drawnItems = new L.FeatureGroup();
                            map.addLayer(drawnItems);
                            function captureData() {

                                // Convert all layers to one GeoJSON object 
                                let geojson = drawnItems.toGeoJSON();

                                // Save JSON text to hidden field 
                                document.getElementById('GeometryGeoJson').value = JSON.stringify(geojson);

                                // Save preview text to hidden field
                                document.getElementById('CoordinatesPreview').value = JSON.stringify(geojson);
                            }
                            function deleteData() {
                                drawnItems.clearLayers();
                                document.getElementById('GeometryGeoJson').value = "";
                                document.getElementById('CoordinatesPreview').value = "";
                            }

                            function onCreated(e) {
                                drawnItems.addLayer(e.layer);
                                captureData();
                            }

                            function onEdited() {
                                captureData();
                            }

                            function onDeleted() {
                                deleteData();
                            }
                            var geojson = @Html.Raw(Model.GeometryGeoJson)//collects data from geometryGeojson, makes it a valid javascript object
                            if (geojson) {
                                var geojsonLayer = L.geoJSON(geojson);
                                geojsonLayer.eachLayer(function(layer) {
                                    drawnItems.addLayer(layer); //legg alle eksisterende lag i drawnItems
                                });
                                map.fitBounds(geojsonLayer.getBounds());
                                captureData();
                            }

                            let drawControl = new L.Control.Draw({
                                draw: {
                                    polygon: false,
                                    polyline: true,
                                    marker: true,
                                    circle: false,  // Disable circle drawing
                                    rectangle: false,
                                    circlemarker: false
                                },
                                edit: {
                                    featureGroup: drawnItems
                                }
                            });
                            map.addControl(drawControl);

                            
                            map.on('draw:created', function (e) {
                                var type = e.layerType,
                                    layer = e.layer;

                                if (type === 'marker') {
                                    // Do marker specific actions
                                }

                                // Do whatever else you need to. (save to db, add to map etc)
                                drawnItems.addLayer(layer);
                            });
                            
                            map.on('draw:edited', function () {
                                // Update db to save latest changes.
                            });

                            map.on('draw:deleted', function () {
                                // Update db to save latest changes.
                            });

                            
                            // Event handlers
                            map.on(L.Draw.Event.CREATED, onCreated);
                            map.on(L.Draw.Event.EDITED, onEdited);
                            map.on(L.Draw.Event.DELETED, onDeleted);
                            

                            </Script> 
                        </details>
                    </div>
                </div>
            }
            <div class = "text-xs font-bold text-gray-900" >Obstacle Report: @Model.GetHashCode()</div>
        </div>
        <input type="hidden" asp-for="Status" id="IsDraft"/>
        <input type="hidden" asp-for="ObstacleId" value="@Model.ObstacleId"/>
        <div class="grid grid-cols-2 gap-6 w-full">
            <button id = "SaveDraft" class="text-white bg-blue-500 hover:bg-blue-700 border-2 border-blue-500  focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2" type="submit">Save draft</button>
            <button id = "Submit" class="text-white bg-blue-500 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2" type="submit">Submit</button>
        </div>
        </form>
</div>

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="~/js/MapScripts/GenerateMap.js" asp-append-version="true"></script>
    <script src="~/js/MapScripts/GenerateMapItems_DataformStep2.js" asp-append-version="true"></script>
    <script src="~/js/MapScripts/Geolocation.js" asp-append-version="true"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script>
        AssignValueByID('SaveDraft', 'IsDraft', 0); // 0 = Draft
        AssignValueByID('Submit', 'IsDraft', 1);    // 1 = Submitted
    </script>
}
